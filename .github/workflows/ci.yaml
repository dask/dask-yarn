name: "CI"
on: [pull_request, push]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - python-version: 3.8
            cluster-config: simple
          - python-version: 3.7
            cluster-config: kerberos

    env:
      CLUSTER_CONFIG: ${{ matrix.cluster-config }}
      PYTHON: ${{ matrix.python-version}}

    steps:
      - name: Checkout Source
      - uses: actions/checkout@main

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          # Install the test cluster
          pip install git+https://github.com/jcrist/hadoop-test-cluster.git
          # Start the test cluster
          htcluster startup --image cdh6 --mount .:dask-yarn --config $CLUSTER_CONFIG
          # No-op to ensure fixuid runs in a more robust way
          htcluster exec -- pwd

      - name: Start Cluster
        run: htcluster exec -- ./dask-yarn/continuous_integration/travis/install.sh $PYTHON

      - name: Test!
        run: |
          export CONDA_ENV=/home/testuser/miniconda/envs/test-environment
          if [[ "$CLUSTER_CONFIG" == "kerberos" ]]; then
              htcluster exec -- kinit testuser -kt testuser.keytab
          fi
          htcluster exec -- ./dask-yarn/continuous_integration/travis/run-tests.sh

